<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>線上用藥記錄瀏覽 · 人名整條彩色標題</title>
  <style>
    :root {
      --fg:#0f172a; --muted:#64748b; --bg:#0b1020; --card:#0f1426; --border:#1f2a44;
      --chip:#11162a; --thead-light:#f6f7fb; --thead-dark:rgba(255,255,255,.04);
    }
    @media (prefers-color-scheme: light){
      :root { --fg:#0b1220; --muted:#5b6b89; --bg:#f6f7fb; --card:#ffffff; --border:#e6e8ef; --chip:#f1f3f9; }
    }

    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--fg);font:15px/1.55 Inter, ui-sans-serif, system-ui,-apple-system, Segoe UI, Roboto, Helvetica, Arial}
    a{color:inherit;text-decoration:none}
    .wrap{max-width:1080px;margin:0 auto;padding:24px 16px 56px}

    .topbar{position:sticky;top:0;z-index:10;background:linear-gradient(180deg, rgba(0,0,0,.25), transparent), var(--bg);
            border-bottom:1px solid var(--border);backdrop-filter:saturate(1.2) blur(6px)}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;padding:12px 16px}
    h1{font-size:20px;margin:0;font-weight:700}
    .ctrl{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-left:auto}
    input[type=text], select{padding:9px 12px;border:1px solid var(--border);border-radius:12px;background:var(--card);color:var(--fg);min-width:380px}
    .btn{padding:10px 14px;border:1px solid var(--border);background:var(--card);border-radius:12px;cursor:pointer}

    .chips{display:flex;gap:8px;flex-wrap:wrap;padding:8px 16px 12px;border-bottom:1px dashed var(--border)}
    .chip{padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:var(--chip);display:inline-flex;gap:8px;align-items:center;cursor:pointer}
    .dot{width:10px;height:10px;border-radius:50%;display:inline-block;border:2px solid rgba(255,255,255,.6)}
    .chip.active{box-shadow:0 0 0 2px hsl(var(--h) 90% 55% / .35) inset}

    .person{background:var(--card);border:1px solid var(--border);border-radius:16px;margin:16px 0;overflow:hidden}

    /* FULL-WIDTH COLORED HEADER per person */
    .person .hdr{
      padding:16px 18px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;
      background:linear-gradient(180deg, hsl(var(--h) 95% 96%), hsl(var(--h) 95% 92%));
    }
    @media (prefers-color-scheme: dark){
      .person .hdr{background:linear-gradient(180deg, hsl(var(--h) 70% 24%), hsl(var(--h) 70% 18%))}
    }
    .name{display:flex;align-items:center;gap:10px;font-weight:900;font-size:18px;letter-spacing:.2px}
    .name .chipdot{width:10px;height:10px;border-radius:50%;background:hsl(var(--h) 90% 45%)}
    .count{font-size:12px;padding:2px 10px;border-radius:999px;border:1px solid rgba(0,0,0,.08);background:rgba(255,255,255,.5)}
    @media (prefers-color-scheme: dark){
      .name{color:#fff}
      .count{border-color:rgba(255,255,255,.2);background:rgba(0,0,0,.25)}
    }

    table{width:100%;border-collapse:collapse;font-variant-numeric:tabular-nums}
    th,td{padding:12px 14px;border-bottom:1px solid var(--border);text-align:left}
    th{background:var(--thead-light);font-weight:700}
    @media (prefers-color-scheme: dark){ th{background:var(--thead-dark)} }

    /* Zebra rows keep per-person hue */
    tbody tr:nth-child(even){ background: hsl(var(--h) 90% 95% / 0.55); }
    tbody tr:nth-child(odd) { background: transparent; }
    @media (prefers-color-scheme: dark){
      tbody tr:nth-child(even){ background: hsl(var(--h) 60% 18% / 0.45); }
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="row">
      <h1>線上用藥記錄瀏覽</h1>
      <div class="ctrl">
        <label>來源
          <select id="mode">
            <option value="apps_script">Apps Script JSON</option>
            <option value="gviz">Google Sheet gviz JSON</option>
          </select>
        </label>
        <input id="url" type="text" placeholder="資料 URL（/exec 或 gviz）" />
        <button id="load" class="btn">讀取</button>
      </div>
    </div>
    <div id="chipBar" class="chips"></div>
  </div>

  <div class="wrap">
    <div id="out"></div>
  </div>

  <script>
    const $ = id => document.getElementById(id);
    const h = (tag, attrs={}, ...kids) => { const el=document.createElement(tag); for(const[k,v]of Object.entries(attrs)){ if(k==="class")el.className=v; else if(k.startsWith("on")&&typeof v==="function")el.addEventListener(k.slice(2),v); else el.setAttribute(k,v);} for(const k of kids)el.append(k?.nodeType?k:document.createTextNode(k)); return el; };
    function fmtTW(input){ try{ const d=new Date(input); if(isNaN(d.getTime())) return String(input); const parts=new Intl.DateTimeFormat('zh-Hant-TW',{timeZone:'Asia/Taipei',year:'numeric',month:'numeric',day:'numeric',weekday:'long',hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false}).formatToParts(d); const m={}; for(const p of parts) if(p.type!=='literal') m[p.type]=p.value; const pad=n=>String(n).padStart(2,'0'); return `${m.year}年${m.month}月${m.day}日(${m.weekday}) ${pad(m.hour)}:${pad(m.minute)}:${pad(m.second)}`;}catch(e){ return String(input);}}
    function hueForName(name){ let h=0; for(let i=0;i<name.length;i++) h=(h*131+name.charCodeAt(i))%360; return h; }
    function parseGviz(text){ const s=text.indexOf("{"), e=text.lastIndexOf("}"); if(s<0||e<0) throw new Error("無法解析 gviz JSON"); const json=JSON.parse(text.slice(s,e+1)); const cols=json.table.cols.map(c=>c.label||c.id||""); const rows=json.table.rows.map(r=>(r.c||[]).map(c=>c?c.v:"")); const ti=cols.findIndex(x=>x.includes("時間")); const ni=cols.findIndex(x=>x.includes("人名")); const mi=cols.findIndex(x=>x.includes("藥名")); if(ti<0||ni<0||mi<0) throw new Error("找不到欄位：時間/人名/藥名"); return rows.map(r=>({time:String(r[ti]??""),name:String(r[ni]??""),medicine:String(r[mi]??"")})); }
    function parseAppsScript(json){ const arr=Array.isArray(json.rows)?json.rows:(Array.isArray(json)?json:[]); return arr.map(x=>({time:String(x.time??x["時間"]??""),name:String(x.name??x["人名"]??""),medicine:String(x.medicine??x["藥名"]??"")})); }
    function group(items){ items.forEach(it=>{ const t=Date.parse(String(it.time).replace(/-/g,'/')); it._ts=isNaN(t)?null:t;}); items.sort((a,b)=>(b._ts??0)-(a._ts??0)); const map=new Map(); for(const it of items){ const k=it.name||"（未填人名）"; if(!map.has(k)) map.set(k,[]); map.get(k).push(it);} return map; }
    function buildChips(groups,onPick){ const bar=$("chipBar"); bar.innerHTML=""; const all=h("div",{class:"chip active",onclick:()=>onPick("")}, h("span",{class:"dot",style:"background:linear-gradient(135deg,#08f,#f0f)"}),"全部"); bar.append(all); for(const [name,list] of groups){ const hue=hueForName(name); const chip=h("div",{class:"chip",onclick:()=>onPick(name),style:`--h:${hue}`}, h("span",{class:"dot",style:`background:hsl(${hue} 90% 55%)`}), name, h("span",{class:"muted"},`  ${list.length}`)); bar.append(chip);} return bar; }
    function render(groups,filterName=""){ const out=$("out"); out.innerHTML=""; const entries=[...groups.entries()].filter(([n])=>!filterName||n===filterName); if(entries.length===0){ out.append(h("p",{class:"muted"},"無資料")); return;} for(const [name,list] of entries){ const hue=hueForName(name); const card=h("div",{class:"person",style:`--h:${hue}`}); const hdr=h("div",{class:"hdr"}, h("div",{class:"name"}, h("span",{class:"chipdot"}), name), h("div",{class:"count"}, `${list.length} 筆`) ); const tbl=h("table",{}); tbl.append(h("thead",{},h("tr",{},h("th",{},"時間"),h("th",{},"藥名")))); const tb=h("tbody",{}); list.forEach(it=>tb.append(h("tr",{},h("td",{},fmtTW(it.time)),h("td",{},it.medicine)))); tbl.append(tb); card.append(hdr,tbl); out.append(card);} }
    async function load(){ const mode=$("mode").value; const url=$("url").value.trim(); if(!url){ $("out").innerHTML="<p class='muted'>未提供 endpoint</p>"; return; } const btn=$("load"); btn.disabled=true; btn.textContent="讀取中"; try{ let items=[]; if(mode==="gviz"){ const txt=await fetch(url,{cache:"no-store"}).then(r=>r.text()); items=parseGviz(txt);}else{ const data=await fetch(url,{cache:"no-store"}).then(r=>r.json()); items=parseAppsScript(data);} const groups=group(items); buildChips(groups,(pick)=>{ [...$("chipBar").children].forEach(c=>c.classList.remove("active")); const idx=pick?[...$("chipBar").children].findIndex(c=>c.textContent.trim().startsWith(pick)):0; $("chipBar").children[idx<0?0:idx].classList.add("active"); render(groups,pick); window.scrollTo({top:document.querySelector(".topbar")?.offsetHeight||0,behavior:"smooth"}); }); render(groups); try{ localStorage.setItem("endpoint",url);}catch(e){} }catch(err){ $("out").innerHTML="<p style='color:#ef4444'>讀取或解析失敗："+(err.message||err)+"</p>"; console.error(err);} finally{ btn.disabled=false; btn.textContent="讀取"; } }
    document.addEventListener("DOMContentLoaded",()=>{ const ep=(new URLSearchParams(location.search)).get("endpoint") || (location.hash.startsWith("#endpoint=")?decodeURIComponent(location.hash.slice(10)):"") || (localStorage.getItem("endpoint")||""); $("mode").value="apps_script"; $("url").value = ep || "https://script.google.com/macros/s/XXXX/exec"; $("load").addEventListener("click", load); if($("url").value) load(); });
  </script>
</body>
</html>
